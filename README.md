# Калькулятор доходов байеров

Streamlit-приложение для объединения файлов сверок, расчёта расходов и анализа XLSX-листов со спендами байеров.

## Возможности

- загрузка нескольких CSV- и XLSX-файлов прямо в интерфейсе;
- очистка данных (игнорируются строки `Всего` / `Итого`, нормализуются числа);
- детальная таблица с разбивкой по типам комиссий;
- сводная таблица по байерам и партнерским программам;
- финальная сводка по байерам с учетoм всех программ;
- выгрузка полученных сводных таблиц в CSV.
- ручной ввод курсов валют → USD для конвертации выручки.
- модуль «Расходники» для расчёта расходов по байерам и типам расходов с итогами.
- модуль «Спенды» для загрузки Excel-листов разных агентств и сверки spend/total по байерам.
- модуль «Объединение» для просмотра сверок, расходов и спендов по выбранному байеру в одном месте.

## Запуск

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
# При работе с XLSX используется `openpyxl` (уже включён в зависимости).
streamlit run app.py
```

После запуска откройте ссылку из терминала (обычно `http://localhost:8501`), загрузите CSV-файлы сверок и используйте фильтры для анализа. В боковой панели отредактируйте курсы валют → USD (по умолчанию 1.0), чтобы пересчитать столбец «Ревеню в $$» и суммы чарджбеков.

> ⚙️ Проект проверен на Python 3.12–3.13. На платформах с Python 3.13 требуется версия pandas 2.2.3 (уже указана в `requirements.txt`).

## Репозиторий

Исходный код опубликован на GitHub:

```bash
git clone https://github.com/Vais96/ZPcalculator.git
cd ZPcalculator
```

## Структура проекта

```
├── app.py                   # Streamlit-приложение
├── requirements.txt         # Зависимости проекта
├── src
│   └── zp_calculator
│       ├── __init__.py
│       └── data_processing.py
└── tests
    └── test_data_processing.py
```

## Тестирование

```bash
pytest
```

Тесты проверяют очистку данных и корректность агрегирования.

## Модуль «Расходники»

- Загрузите CSV из таблицы расходов (пример — файл «Расходники СЕНТЯБРЬ - Лист1.csv»).
- Для каждого блока должно быть название типа расхода в строке выше строк "Байер", "Кол-во", "Сумма".
- Внутри блоков модуль извлечёт значения по каждому байеру, посчитает суммы и позволит скачать детализацию.
- Итоги, указанные в исходном файле, игнорируются — приложение пересчитывает их автоматически.
- В боковой панели отображаются быстрые метрики: общий расход и количество активных байеров.

## Модуль «Спенды»

- Принимаются XLSX/XLS-файлы (читаются все листы) или отдельные CSV-выгрузки одного листа.
- Обязательные колонки на листе: **Байер**, **Имя аккаунта** (или **Карта**), **ID аккаунта**, **Spend**. Колонка **Total** опциональна.
- Приложение очищает ID аккаунтов от служебных символов, нормализует числовые значения и сохраняет дополнительные колонки в комментарии.
- В интерфейсе доступны фильтры по листам, байерам и валютам. Отчёты строятся в разрезе строк, байеров и листов с возможностью скачать CSV.
- В боковой панели отображаются суммарный spend, количество байеров и количество листов в отфильтрованном наборе.
- При запуске без виртуального окружения убедитесь, что установлен пакет `openpyxl` (используется pandas для чтения Excel).

## Модуль «Объединение»

- Загрузите файлы со сверками (CSV/XLSX), расходниками (CSV/XLSX) и спендами (XLSX/XLS/CSV).
- После загрузки выберите байера — приложение сформирует три блока: выплаты по сверкам, расходы и спенды с разбивкой по листам.
- Курсы валют для сверок и спендов настраиваются в сайдбаре, все суммы приводятся к USD.
- Для каждого блока доступны выгрузки в CSV, как и в отдельных модулях.

## Ограничения и дальнейшее развитие

- Суммы агрегируются по валюте, указанной в файле. Если валюта отсутствует или файлы содержат разные валюты, итоговые таблицы покажут их по отдельности.
- При необходимости можно добавить загрузку заранее настроенных справочников (например, для нормализации имен байеров).
- Курсы задаются вручную на текущий сеанс. При смене файла/обновлении страницы значения нужно вводить снова (по умолчанию 1.0).
